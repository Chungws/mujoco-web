# Feature: VLA Arena MVP

**Status:** Week 2 - Backend Foundation
**Priority:** HIGH
**Timeline:** Week 1-7 (7 weeks)
**Target Date:** Week 7 completion

---

## ğŸ“‹ Overview

Complete VLA model comparison platform with blind A/B testing, server-side episode generation, browser-based replay, voting, and robot-specific ELO leaderboard.

**Key Differentiators:**
- All server-side execution (MuJoCo + VLA inference)
- State-based replay (not video) for interactive debugging
- Robot-specific ELO rankings
- MongoDB for episode storage

---

## ğŸ¯ MVP Scope

### What's Included
- âœ… 1 robot (WidowX)
- âœ… 1 scene (Table pick-and-place)
- âœ… 2 VLA models (OpenVLA 7B, Octo-base)
- âœ… Session management (random model assignment)
- âœ… Multi-turn battles (multiple instructions per session)
- âœ… Episode generation (server-side, up to 50 steps)
- âœ… Browser-based state replay (MuJoCo WASM)
- âœ… Voting system (A/B/Tie/Both Bad)
- âœ… Robot-specific + Global ELO leaderboard
- âœ… Hourly worker aggregation

### What's Deferred (Post-MVP)
- âŒ Multiple robots (Franka, UR5)
- âŒ Multiple scenes (Kitchen, Warehouse)
- âŒ Video recording
- âŒ Real-time execution visualization
- âŒ User authentication
- âŒ Scene-specific ELO

---

## ğŸ—ï¸ Architecture

### High-Level Flow

```
User Flow:
1. Visit /battle â†’ System creates Session
2. System assigns 2 random VLA models (hidden)
3. User provides instruction: "Pick up the red cube"
4. Server executes both models (parallel) â†’ Save episodes to MongoDB
5. Frontend loads states â†’ MuJoCo WASM renders side-by-side
6. User votes (A/B/Tie/Both Bad) â†’ Reveal model identities
7. (Optional) User provides another instruction â†’ repeat from step 3
8. Worker runs hourly â†’ Aggregate votes â†’ Update ELO rankings
```

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Next.js Frontend (Browser)                â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Battle Page (/battle)                     â”‚  â”‚
â”‚  â”‚  - Instruction input                       â”‚  â”‚
â”‚  â”‚  - Side-by-side MuJoCo WASM viewers        â”‚  â”‚
â”‚  â”‚  - Loading state during server execution   â”‚  â”‚
â”‚  â”‚  - Voting interface (after replay)         â”‚  â”‚
â”‚  â”‚  - Model reveal                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Leaderboard Page (/leaderboard)          â”‚  â”‚
â”‚  â”‚  - WidowX rankings (robot-specific)       â”‚  â”‚
â”‚  â”‚  - Global rankings                         â”‚  â”‚
â”‚  â”‚  - Sort by ELO/Votes/Win Rate             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ REST API
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   FastAPI Backend        â”‚
    â”‚                           â”‚
    â”‚  POST /api/sessions/init â”‚ â†’ Create session + battle
    â”‚  POST /api/battles/{id}/turns â”‚ â†’ Execute VLA models
    â”‚  POST /api/votes         â”‚ â†’ Submit vote
    â”‚  GET  /api/leaderboard   â”‚ â†’ Get rankings
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   VLA Execution Service    â”‚
    â”‚                             â”‚
    â”‚  - Load MuJoCo scene        â”‚
    â”‚  - Run VLA inference        â”‚
    â”‚  - Record states (50 steps) â”‚
    â”‚  - Save to MongoDB          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL               â”‚     â”‚   MongoDB     â”‚
    â”‚  - sessions                â”‚     â”‚  - episodes   â”‚
    â”‚  - battles                 â”‚     â”‚    (actions,  â”‚
    â”‚  - turns                   â”‚     â”‚     states,   â”‚
    â”‚  - votes                   â”‚     â”‚     metrics)  â”‚
    â”‚  - model_stats_by_robot    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  - model_stats_total       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Worker (APScheduler)   â”‚
    â”‚  - Hourly aggregation    â”‚
    â”‚  - ELO calculation       â”‚
    â”‚  - Update model_stats    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Database Schema

**See:** [ADR-002](../ARCHITECTURE/ADR_002-Database_Schema.md) for complete specification

### PostgreSQL Tables

1. **sessions** - robot_id, scene_id, user_id (optional)
2. **battles** - session_id, seq_in_session, left/right_model_id
3. **turns** - battle_id, seq, instruction
4. **votes** - robot_id, scene_id, left/right_model_id (denormalized)
5. **model_stats_by_robot** - (model_id, robot_id) PK, elo_score
6. **model_stats_total** - model_id PK, elo_score
7. **worker_status** - last_run_at, votes_processed

### MongoDB Collection

**episodes** - episode_id, battle_id, turn_id, side, model_id, actions[], states[], duration_ms

**Size:** ~13 KB max (50 steps), average ~8 KB

---

## ğŸ”§ Implementation Guide

### Step 1: Update PostgreSQL Models

**File:** `shared/src/vlaarena_shared/models.py`

**Changes:**
- Session: Add `robot_id`, `scene_id`; Remove `title`
- Turn: `user_input` â†’ `instruction`
- Message: DELETE (replaced by MongoDB)
- Vote: Add `robot_id`, `scene_id` (denormalized)
- ModelStats: SPLIT â†’ `ModelStatsByRobot` + `ModelStatsTotal`

**Complete code:** See [implementation appendix](#appendix-complete-models-code) below

---

### Step 2: MongoDB Connection

**File:** `shared/src/vlaarena_shared/mongodb.py` (NEW)

```python
from motor.motor_asyncio import AsyncIOMotorClient
from pymongo import IndexModel

mongodb_client: AsyncIOMotorClient = None


async def connect_mongodb():
    global mongodb_client
    mongodb_client = AsyncIOMotorClient(settings.MONGODB_URI)
    db = mongodb_client[settings.MONGO_DATABASE]

    # Create indexes (ADR-002)
    await db.episodes.create_indexes([
        IndexModel("episode_id", unique=True),
        IndexModel([("battle_id", 1), ("side", 1)]),
        IndexModel("turn_id"),
    ])


def get_episodes_collection():
    return mongodb_client[settings.MONGO_DATABASE]["episodes"]
```

---

### Step 3: Alembic Migration

```bash
cd backend
uv run alembic revision --autogenerate -m "VLA Arena schema"
uv run alembic upgrade head
```

---

### Step 4: API Endpoints

**Session & Battle Creation:**
```python
POST /api/sessions/init
{
  "robot_id": "widowx",
  "scene_id": "table"
}

Response:
{
  "session_id": "sess_abc123",
  "battle_id": "battle_def456",
  "left_model": "???",  # Hidden
  "right_model": "???"  # Hidden
}
```

**Turn Execution:**
```python
POST /api/battles/{battle_id}/turns
{
  "instruction": "Pick up the red cube"
}

Response:
{
  "turn_id": "turn_ghi789",
  "left_episode_id": "ep_left_123",
  "right_episode_id": "ep_right_456",
  "status": "completed"
}
```

**Get Episodes:**
```python
GET /api/episodes/{episode_id}

Response:
{
  "episode_id": "ep_left_123",
  "actions": [[0.1, 0.2, ...], ...],
  "states": [{"qpos": [...], "qvel": [...], "time": 0.0}, ...]
}
```

**Voting:**
```python
POST /api/votes
{
  "battle_id": "battle_def456",
  "vote": "left_better"  # or "right_better", "tie", "both_bad"
}

Response:
{
  "vote_id": "vote_jkl012",
  "revealed_models": {
    "left": "openvla-7b",
    "right": "octo-base"
  }
}
```

**Leaderboard:**
```python
GET /api/leaderboard?robot_id=widowx

Response:
{
  "rankings": [
    {
      "model_id": "openvla-7b",
      "name": "OpenVLA 7B",
      "elo_score": 1650,
      "vote_count": 42,
      "win_rate": 0.62
    },
    ...
  ]
}
```

---

## ğŸ“… Weekly Breakdown

### Week 1: Project Setup âœ…
- [x] WORKSPACE documentation
- [x] ADR-001, ADR-002
- [x] Docker Compose (PostgreSQL + MongoDB)
- [x] lmarena-clone structure adoption

### Week 2-3: Backend Foundation (Current)
- [x] Update PostgreSQL models (Step 1)
- [x] MongoDB connection (Step 2)
- [x] Alembic migration (Step 3)
- [x] API Schemas (Session, Turn, Episode, Vote, Leaderboard) - TDD
- [x] Session API (POST /sessions/init) - TDD with 15 tests
- [x] Models list API (GET /models) - TDD with 3 tests
- [x] VLA execution service (mock) - TDD with 9 tests

### Week 3-4: VLA Execution
- [ ] MuJoCo server-side setup
- [ ] VLA model loading (OpenVLA 7B, Octo-base)
- [ ] Episode generation (actions + states recording)
- [x] Turn API (POST /battles/{id}/turns) - TDD with 7 tests
- [x] Episodes API (GET /episodes/{id}) - TDD with 5 tests

### Week 4-5: Frontend
- [ ] Battle page (/battle)
- [ ] MuJoCo WASM integration (state replay)
- [ ] Side-by-side viewers
- [ ] Voting interface
- [ ] Leaderboard page (/leaderboard)

### Week 5-6: Worker & Leaderboard
- [ ] Worker setup (APScheduler)
- [ ] Vote aggregation
- [ ] ELO calculation (robot-specific + global)
- [ ] Update model_stats tables
- [ ] Leaderboard API

### Week 6-7: Testing & Polish
- [ ] Backend tests (pytest)
- [ ] Frontend tests (Playwright)
- [ ] End-to-end testing
- [ ] Performance optimization
- [ ] Documentation
- [ ] Deployment

---

## ğŸ§ª Testing Strategy

### Backend Tests
- Unit tests for ELO calculation
- Integration tests for API endpoints
- MongoDB episode storage tests

### Frontend Tests
- Chrome DevTools MCP for UI verification
- State replay rendering tests
- Voting flow end-to-end

### Performance Targets
- VLA execution: < 60s per episode (50 steps)
- API response: < 500ms (95th percentile)
- Leaderboard load: < 1s
- Episode replay: 30 FPS in browser

---

## ğŸ“– API Specification

### Core Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/sessions/init | Create session + battle |
| GET | /api/sessions/{id} | Get session details |
| POST | /api/battles/{id}/turns | Execute VLA models |
| GET | /api/episodes/{id} | Get episode data (MongoDB) |
| POST | /api/votes | Submit vote + reveal models |
| GET | /api/leaderboard | Get rankings (robot-specific or global) |
| GET | /api/models | List available VLA models |
| GET | /api/health | Health check |

---

## ğŸ¯ Success Criteria

### MVP Complete When:
1. âœ… Users can create battles (1 robot, 1 scene)
2. âœ… System assigns 2 random VLA models (hidden)
3. âœ… Server executes both models (50 steps max)
4. âœ… Browser replays episodes (MuJoCo WASM state-based)
5. âœ… Users can vote and see model reveal
6. âœ… Leaderboard displays WidowX-specific + Global ELO
7. âœ… Worker aggregates votes hourly
8. âœ… All tests pass
9. âœ… Performance targets met

---

## ğŸš€ Post-MVP Roadmap

### Phase 2: Content Expansion
- Add Franka, UR5 robots
- Add Kitchen, Warehouse scenes
- Add 3-5 more VLA models
- Scene-specific ELO rankings

### Phase 3: Advanced Features
- Video thumbnail generation
- Real-time execution streaming
- Multi-step task sequences
- Heatmap visualization (attention maps)

### Phase 4: Community
- User authentication
- Public battle links
- Comments and discussions
- Model upload interface

---

## ğŸ“š References

### Architecture Decisions
- [ADR-001: Server-Side Execution](../ARCHITECTURE/ADR_001-Server_Side_Execution.md)
- [ADR-002: Database Schema](../ARCHITECTURE/ADR_002-Database_Schema.md)

### Development Guides
- [ROADMAP.md](../ROADMAP.md) - Week-by-week progress tracking
- [00_PROJECT.md](../00_PROJECT.md) - Project overview
- [lmarena-clone](../../lmarena-clone) - Reference implementation

---

## ğŸ“ Appendix: Complete Models Code

**File:** `shared/src/vlaarena_shared/models.py`

<details>
<summary>Click to expand complete PostgreSQL models</summary>

```python
"""
SQLModel models for PostgreSQL (VLA Arena MVP)
Based on ADR-002: Database Schema Design
"""

from datetime import UTC, datetime
from typing import Optional

from sqlalchemy import DateTime
from sqlmodel import Column, Field, SQLModel


class Session(SQLModel, table=True):
    __tablename__ = "sessions"

    id: Optional[int] = Field(default=None, primary_key=True)
    session_id: str = Field(unique=True, index=True, max_length=50)
    robot_id: str = Field(max_length=50)
    scene_id: str = Field(max_length=50)
    user_id: Optional[str] = Field(default=None, index=True, max_length=50)
    created_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )
    last_active_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False, index=True),
    )


class Battle(SQLModel, table=True):
    __tablename__ = "battles"

    id: Optional[int] = Field(default=None, primary_key=True)
    battle_id: str = Field(unique=True, index=True, max_length=50)
    session_id: str = Field(index=True, max_length=50)
    seq_in_session: int = Field(index=True)

    left_model_id: str = Field(max_length=255)
    right_model_id: str = Field(max_length=255)

    status: str = Field(default="ongoing", max_length=20, index=True)
    created_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False, index=True),
    )
    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )


class Turn(SQLModel, table=True):
    __tablename__ = "turns"

    id: Optional[int] = Field(default=None, primary_key=True)
    turn_id: str = Field(unique=True, index=True, max_length=50)

    session_id: str = Field(index=True, max_length=50)
    battle_id: str = Field(index=True, max_length=50)
    battle_seq_in_session: int = Field(index=True)

    seq: int = Field(index=True)
    instruction: str

    created_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False, index=True),
    )


class Vote(SQLModel, table=True):
    __tablename__ = "votes"

    id: Optional[int] = Field(default=None, primary_key=True)
    vote_id: str = Field(unique=True, index=True, max_length=50)
    battle_id: str = Field(unique=True, index=True, max_length=50)
    session_id: str = Field(index=True, max_length=50)

    robot_id: str = Field(index=True, max_length=50)
    scene_id: str = Field(index=True, max_length=50)

    left_model_id: str = Field(max_length=255)
    right_model_id: str = Field(max_length=255)

    vote: str = Field(max_length=20)

    processing_status: str = Field(default="pending", max_length=20, index=True)
    processed_at: Optional[datetime] = Field(
        default=None, sa_column=Column(DateTime(timezone=True), nullable=True)
    )
    error_message: Optional[str] = Field(default=None)
    voted_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False, index=True),
    )


class ModelStatsByRobot(SQLModel, table=True):
    __tablename__ = "model_stats_by_robot"

    id: Optional[int] = Field(default=None, primary_key=True)
    model_id: str = Field(index=True, max_length=255)
    robot_id: str = Field(index=True, max_length=50)

    elo_score: int = Field(default=1500, index=True)
    elo_ci: float = Field(default=200.0)
    vote_count: int = Field(default=0, index=True)
    win_count: int = Field(default=0)
    loss_count: int = Field(default=0)
    tie_count: int = Field(default=0)
    win_rate: float = Field(default=0.0)
    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )


class ModelStatsTotal(SQLModel, table=True):
    __tablename__ = "model_stats_total"

    id: Optional[int] = Field(default=None, primary_key=True)
    model_id: str = Field(unique=True, index=True, max_length=255)

    elo_score: int = Field(default=1500, index=True)
    elo_ci: float = Field(default=200.0)
    vote_count: int = Field(default=0, index=True)
    win_count: int = Field(default=0)
    loss_count: int = Field(default=0)
    tie_count: int = Field(default=0)
    win_rate: float = Field(default=0.0)

    organization: str = Field(max_length=255)
    license: str = Field(max_length=50)

    updated_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )


class WorkerStatus(SQLModel, table=True):
    __tablename__ = "worker_status"

    id: Optional[int] = Field(default=None, primary_key=True)
    worker_name: str = Field(unique=True, max_length=100)
    last_run_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )
    status: str = Field(max_length=50)
    votes_processed: int = Field(default=0)
    error_message: Optional[str] = Field(default=None, max_length=1000)
```

</details>

---

**Created:** 2025-01-04
**Last Updated:** 2025-01-04
**Status:** Active Development (Week 2)
